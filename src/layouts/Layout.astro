---
interface Props {
  goBackTo: string;
  title?: string;
  description?: string;
}
const { goBackTo, title, description } = Astro.props;

import "../styles/global.css";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title}</title>
    <meta name="description" content={description} />
  </head>
  <body
    class="w-full h-full bg-[url('/imgs/bg.webp')] bg-cover bg-center bg-no-repeat font-['Muli'] overflow-y-scroll grid min-h-[100dvh] grid-rows-[auto_1fr_auto]"
  >
    <header
      class="w-full h-[9.5rem] flex flex-col gap-2 pt-8 m-0 px-[5%] text-[var(--blanco-08)] bg-[var(--azul-primario-04)] backdrop-blur-md fixed z-20"
    >
      <div
        class="flex w-full justify-between border border-[var(--blanco-04)] sm:border-none rounded-xl sm:rounded-none"
      >
        <a
          href="/services"
          class="m-0 w-1/3 h-14 sm:w-28 bg-[var(--azul-primario-04)] backdrop-blur-sm py-2 pr-4 sm:p-0 glass-effect m-only"
        >
          <img
            src="/icons/icon-home-filled.svg"
            class="h-full w-14 sm:w-9 pl-3 sm:p-0"
          />
        </a>
        <div
          class="border-none sm:border-solid sm:border-[var(--blanco-06)] sm:border sm:rounded-xl sm:box-border w-2/3 sm:w-max sm:grow flex justify-between items-center h-14 bg-[var(--azul-noche-04)] backdrop-blur-sm sm:px-3"
          id="userProfileBtn"
        >
          <div class="h-full flex items-center">
            <img
              src="/icons/icon-user.svg"
              alt="User"
              class="h-full py-2 pr-2"
            />
            <span>Kevin Briones</span>
          </div>
          <img
            src="/icons/icon-arrow-down.svg"
            alt="More"
            class="h-full p-3 sm:px-0 cursor-pointer transition-transform duration-300 ease-in-out rotate-0"
            id="arrowIcon"
          />
        </div>
      </div>
      <a
        href={goBackTo}
        id="arrowLeft"
        class="flex items-center gap-1 w-fit h-6 bg-[var(--azul-primario-04)] backdrop-blur-sm text-[var(--blanco-08)] no-underline text-xs font-semibold absolute left-0 md:left-[5%] top-28 hover:text-[var(--cyan-neon)] transition-colors duration-300 ease-in-out py-2 pr-4 rounded-lg glass-effect"
      >
        <svg
          width="80"
          height="48"
          viewBox="0 0 80 48"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-fit transition-colors duration-300 ease-in-out"
        >
          <g clip-path="url(#clip0_2_21)">
            <path
              d="M11.2597 26.1863L74.0397 26.1863C74.8997 26.1863 75.9597 24.5463 75.9997 23.7063C76.0197 22.7663 74.9997 21.0263 74.0397 21.0263L11.2597 21.0263L25.7397 6.4663C27.7997 4.0063 24.8997 0.626302 22.2397 2.5863L3.15971 21.4863C1.95971 22.6863 1.89971 24.4063 3.07971 25.6463L22.2597 44.6263C24.8197 46.5063 27.7397 43.4263 25.8597 40.8463L11.2597 26.1863Z"
              fill="currentColor"></path>
          </g>
          <defs>
            <clipPath id="clip0_2_21">
              <rect
                width="48"
                height="80"
                fill="currentColor"
                transform="translate(80 3.49691e-06) rotate(90)"></rect>
            </clipPath>
          </defs>
        </svg>
        Regresar
      </a>
      <!-- User Menu Overlay -->
      <div
        class="flex h-fit w-full sm:w-[calc(100%_-_112px)] border border-[var(--blanco-total)] rounded-xl p-4 bg-[var(--azul-noche-04)] backdrop-blur-[12px] invisible opacity-0 -translate-y-[10px] transition-all duration-300 ease-in-out relative z-10 sm:left-28 [&.show-menu]:visible [&.show-menu]:opacity-100 [&.show-menu]:translate-y-0 glass-effect"
        id="userMenu"
      >
        <div class="user-menu-row">
          <p>Correo: <span id="company-email">correo@mail.com</span></p>
          <p>Nombre de Empresa: <span id="company-name">Nivek</span></p>
          <div class="flex justify-between items-center">
            <a href="/change_password_internal" class="menu-link"
              >Cambio de clave</a
            >
            <button class="menu-link-btn" id="logoutBtn">Cerrar Sesión</button>
          </div>
        </div>
      </div>
    </header>
    <slot />
  </body>
  <footer class="dashboard-footer">
    <img src="/imgs/logo-white.svg" alt="Comsatel Logo" class="footer-logo" />
    <span class="footer-text">COMSATEL</span>
  </footer>
</html>

<script>
  const userProfileBtn = document.getElementById("userProfileBtn");
  const userMenu = document.getElementById("userMenu");
  const arrowIcon = document.getElementById("arrowIcon");
  const logoutBtn = document.getElementById("logoutBtn");

  // Función auxiliar para cerrar el menú
  const closeMenu = () => {
    userMenu?.classList.remove("show-menu");
    arrowIcon?.classList.remove("flip");
  };

  // 1. ABRIR / CERRAR AL DAR CLICK AL BOTÓN DE PERFIL
  userProfileBtn?.addEventListener("click", (e) => {
    // Evitamos que este click se propague al document (que cerraría el menú inmediatamente)
    e.stopPropagation();
    userMenu?.classList.toggle("show-menu");
    arrowIcon?.classList.toggle("flip");
  });

  // 2. CERRAR AL DAR CLICK EN CUALQUIER PARTE FUERA DEL MENÚ
  document.addEventListener("click", (e) => {
    // Si el menú está abierto Y el click NO fue dentro del menú
    const clickTarget = e.target;
    if (
      userMenu?.classList.contains("show-menu") &&
      clickTarget instanceof Node &&
      !userMenu.contains(clickTarget)
    ) {
      closeMenu();
    }
  });

  // 3. CERRAR AL DAR CLICK EN UNA OPCIÓN DEL MENÚ
  // Seleccionamos todos los enlaces o botones dentro del menú
  const menuLinks = userMenu?.querySelectorAll("a, button");

  menuLinks?.forEach((link) => {
    link.addEventListener("click", () => {
      // Si es el botón de logout, ejecutamos su lógica específica primero
      if (link.id === "logoutBtn") return;

      closeMenu();
    });
  });

  function logout() {
    // Tu lógica de logout existente
    localStorage.removeItem("usuarioLogueado");
    window.location.href = "/";
  }

  logoutBtn?.addEventListener("click", logout);

  /* PADDING RESIZING */
  /**
   * Función maestra para sincronizar el layout fijo en Safari/Móvil.
   * Mide el header y clona sus métricas exactas al stats-box,
   * y luego fija el stats-box debajo del header.
   */
  function makeStatsBoxStickyAndMatching(): void {
    // 1. Obtener referencias a los elementos clave
    const header = document.querySelector("header");
    // El cuadro azul de estadísticas
    const statsBox = document.querySelector(".stats-box") as HTMLElement;
    // El contenedor principal que debe scrollear DEBAJO de los elementos fijos.
    // CAMBIA '.main-scroll-container' POR LA CLASE REAL DE TU CONTENEDOR DE LISTA
    const contentBelow = document.querySelector(
      ".main-scroll-container"
    ) as HTMLElement;

    // Validaciones de seguridad
    if (!header || !statsBox || !(header instanceof HTMLElement)) {
      console.error(
        "No se encontraron los elementos necesarios (header o .stats-box)"
      );
      return;
    }

    // --- PASO 1: MEDICIÓN EXACTA (La clave para Safari) ---

    // Usamos getComputedStyle para obtener los valores REALES en píxeles
    // que el navegador está usando para el header.
    const headerStyles = window.getComputedStyle(header);

    // Obtenemos el padding exacto (ej: "18.5px")
    const exactPaddingLeft = headerStyles.paddingLeft;
    const exactPaddingRight = headerStyles.paddingRight;

    // Obtenemos la altura exacta del header para saber dónde colocar el stats-box
    // offsetHeight incluye borders y paddings verticales si los hubiera.
    const headerHeight = header.offsetHeight;
    const headerWidth = header.offsetWidth;

    // --- PASO 2: APLICAR ESTILOS AL STATS-BOX ---

    // Reseteamos estilos previos por si acaso
    statsBox.style.cssText = "";

    // Aplicamos la magia
    Object.assign(statsBox.style, {
      // Lo hacemos fijo para que no scrollee
      position: "fixed",
      // Lo colocamos exactamente donde termina el header
      top: `${headerHeight}px`,
      left: "0",
      // Ancho total
      width: "100%",
      // CRUCIAL: border-box para que el padding no sume al 100% de ancho
      boxSizing: "border-box",
      // Inyectamos los paddings idénticos a los del header
      paddingLeft: exactPaddingLeft,
      paddingRight: exactPaddingRight,
      // Nos aseguramos que esté por encima del contenido pero debajo del header (si header tiene z-index 100)
      zIndex: "90",
      // Opcional: si necesitas un fondo para que no se transparente el contenido al hacer scroll
      backgroundColor: "#0a192f", // Usa el color de fondo real de tu app
    });

    // --- PASO 3: EMPUJAR EL CONTENIDO DE ABAJO ---

    // Ahora que el header y el stats-box son fijos, el contenido de abajo
    // saltará hacia arriba y se esconderá detrás de ellos. Debemos empujarlo.

    if (contentBelow && contentBelow instanceof HTMLElement) {
      // Medimos la altura del stats-box una vez que ya está fijado y con paddings
      const statsBoxHeight = statsBox.offsetHeight;
      // La altura total que ocupan los elementos fijos
      const totalFixedOffset = headerHeight + statsBoxHeight;

      // Aplicamos un margen superior al contenido scrolleable
      // Añadimos un pequeño extra (ej. 20px) para separación visual.
      contentBelow.style.marginTop = `${totalFixedOffset + 20}px`;
    }
  }

  // --- EJECUCIÓN ---

  function syncResizeContainers(): void {
    // 1. Recuperamos el ancho TOTAL de la ventana (el viewport)
    // En tu ejemplo: 375px
    const viewportWidth = window.innerWidth;

    // 2. Calculamos el 5% exacto
    // En tu ejemplo: 375 * 0.05 = 18.75 -> Math.floor lo deja en 18px
    const paddingPx = Math.floor(viewportWidth * 0.05);

    // 3. Buscamos TODOS los elementos con la clase "resize-container"
    const containers = document.querySelectorAll(".resize-content");

    // 4. Les inyectamos ese padding calculado
    containers.forEach((container) => {
      // Verificación de tipo para TS
      if (container instanceof HTMLElement) {
        // Forzamos box-sizing para que el padding no aumente el ancho total
        container.style.boxSizing = "border-box";

        // Ancho total del viewport
        container.style.width = "100%";

        // Aplicamos los 18px (o lo que salga del cálculo) a cada lado
        container.style.paddingLeft = `${paddingPx}px`;
        container.style.paddingRight = `${paddingPx}px`;
      }
    });
  }

  function syncWidthLikeHeader(): void {
    const header = document.querySelector("header");

    // Validación de seguridad para TS: Si no hay header, no hacemos nada
    if (!header) return;

    // 1. OBTENEMOS LA MEDIDA EXACTA DEL HEADER
    // getBoundingClientRect().width es ideal porque te da el ancho renderizado real,
    // incluso con decimales, del elemento fixed.
    const headerWidth = header.getBoundingClientRect().width;

    // Calculamos el 5% basado en el ancho del header
    const paddingPx = Math.floor(headerWidth * 0.05);

    const containers = document.querySelectorAll(".like-header");

    const arrowLeft = document.getElementById("arrowLeft");

    if (arrowLeft instanceof HTMLElement)
      arrowLeft.style.marginLeft = `${paddingPx}px`;

    containers.forEach((container) => {
      if (container instanceof HTMLElement) {
        container.style.boxSizing = "border-box";

        // 2. APLICAMOS EL ANCHO DEL HEADER
        // Es crucial poner 'px' para que CSS/TS lo acepte
        container.style.width = `${headerWidth - paddingPx * 2}px`;
      }
    });
  }

  // --- FUNCIÓN ORQUESTADORA ---
  // Ejecuta ambas funciones en orden
  function runAllResizeTasks(): void {
    // 1. Ejecutar tu función de redimensionamiento de contenedores
    if (typeof syncResizeContainers === "function") {
      syncResizeContainers();
    }

    // 2. Ejecutar la sincronización con el header
    syncWidthLikeHeader();
  }

  // --- EJECUCIÓN ---

  // Ejecutar al inicio
  window.addEventListener("DOMContentLoaded", runAllResizeTasks);
  window.addEventListener("load", runAllResizeTasks);

  // Ejecutar al redimensionar (con debounce para rendimiento)
  let resizeTimer: number | undefined;

  window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = window.setTimeout(runAllResizeTasks, 100);
  });
</script>

<style is:global>
  @font-face {
    font-family: "Muli";
    src: url("/fonts/Muli-Regular.ttf") format("truetype");
    font-weight: 400;
    font-style: normal;
  }

  @font-face {
    font-family: "Muli";
    src: url("/fonts/Muli-Bold.ttf") format("truetype");
    font-weight: 700;
    font-style: normal;
  }

  @font-face {
    font-family: "Muli";
    src: url("/fonts/Muli-ExtraLight.ttf") format("truetype");
    font-weight: 200;
    font-style: normal;
  }

  :root {
    /* Blancos */
    --blanco-total: #ffffff;
    --blanco-08: rgba(255, 255, 255, 0.8);
    --blanco-06: rgba(255, 255, 255, 0.6);
    --blanco-04: rgba(255, 255, 255, 0.4);
    --blanco-02: rgba(255, 255, 255, 0.2);
    --blanco-016: rgba(255, 255, 255, 0.16);
    --blanco-006: rgba(255, 255, 255, 0.06);
    --blanco-004: rgba(255, 255, 255, 0.04);

    /* Azules Primarios (22, 33, 62) */
    --azul-primario-total: rgb(22, 33, 62);
    --azul-primario-096: rgba(22, 33, 62, 0.96);
    --azul-primario-08: rgba(22, 33, 62, 0.8);
    --azul-primario-06: rgba(22, 33, 62, 0.6);
    --azul-primario-04: rgba(22, 33, 62, 0.4);

    /* Otros Azules */
    --azul-oscuro: #1c2e4a;
    --azul-medio: #3a506b;
    --azul-grisaceo: #2b3d55;
    --azul-profundo: rgba(0, 15, 35, 1);
    --azul-acero-10: rgb(68, 96, 117);
    --azul-noche-10: rgb(10, 25, 47);
    --azul-noche-04: rgba(10, 25, 47, 0.4);

    /* Cyan */
    --cyan-neon: #00d2ff;
    --cyan-neon-06: rgba(0, 210, 255, 0.6);
    --cyan-neon-02: rgba(0, 210, 255, 0.2);
    --cyan-hover: #00b8e6;
    --cyan-neon-00: rgba(0, 210, 255, 0);

    /* Negro/Sombras */
    --negro-06: rgba(0, 0, 0, 0.6);
    --negro-04: rgba(0, 0, 0, 0.4);
    --negro-02: rgba(0, 0, 0, 0.2);

    /* Estados */
    --estado-activo: #4caf50;
    --estado-finalizando: #ff9800;
    --estado-inactivo: #f44336;
    --gris-texto: #555;

    /* Variables Legacy (Mapeadas a las nuevas) */
    --bg-white: var(--blanco-total);
    --primary-gradient: linear-gradient(
      180deg,
      var(--azul-medio) 0%,
      var(--azul-oscuro) 100%
    );
    --accent-cyan: var(--cyan-neon);
    --text-white: var(--blanco-total);
    --input-border: var(--blanco-08);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  .dashboard-header {
    position: absolute;
    width: 90%;
    margin: 2rem 1rem 0;
    color: var(--blanco-total);
    z-index: 1;
  }
  .home-icon-container {
    width: 3.5rem;
    height: 3.5rem;
    margin: 0 auto;
  }
  .home-icon {
    width: 100%;
    padding: 0.75rem;
    cursor: pointer;
    background-color: var(--azul-noche-04);
    backdrop-filter: blur(5px);
    border-radius: 12px;
  }
  .home-icon:hover {
    background: var(--azul-primario-06);
    color: var(--blanco-total);
    border: 1px solid var(--blanco-04);
  }
  .user-profile {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--blanco-total);
    border-radius: 12px;
    height: 3.5rem;
    background: var(--azul-noche-04);
    backdrop-filter: blur(5px);
  }
  .user-info {
    height: 100%;
    display: flex;
    align-items: center;
  }
  .user-icon {
    height: 100%;
    padding: 0.5rem;
  }
  .arrow-icon {
    height: 100%;
    padding: 0.75rem;
    cursor: pointer;
    transition: transform 0.3s ease-in-out;
    transform: rotate(0deg);
  }

  .flip {
    transform: rotate(180deg);
  }

  .show-menu {
    /* CAMBIOS PARA MOSTRAR */
    visibility: visible;
    opacity: 1;
    transform: translateY(0);

    background-color: var(--azul-primario-04);

    /* 2. El truco para SAFARI (iOS/macOS) */
    -webkit-backdrop-filter: blur(12px);

    /* 3. El estándar para Chrome, Edge, Firefox */
    backdrop-filter: blur(12px);
  }

  .user-menu-row {
    font-size: 14px;
    width: 100%;
    font-weight: 600;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 0.75rem;

    p {
      display: flex;
      gap: 0.5rem;
    }
  }

  .back-link-container {
    display: flex;
    align-items: center;
    width: 6rem;
    height: fit-content;
    background: var(--azul-primario-04);
    backdrop-filter: blur(5px);
    color: var(--blanco-08);
    text-decoration: none;
    font-size: 0.75rem;
    position: absolute;
    margin: 0;
    bottom: 0rem;
    gap: 0.25rem;
    font-weight: 600;
    border-radius: 8px;
    padding: 0.5rem;
    margin-left: -1rem;

    img {
      width: 1.5rem;
      margin: 0;
    }
  }

  .back-link-container:hover {
    background: var(--azul-primario-06);
    color: var(--blanco-total);
    border: 1px solid var(--blanco-04);
  }

  .menu-link,
  .menu-link-btn {
    cursor: pointer;
    color: var(--cyan-neon);
    font-weight: 400;
    transition: color 0.3s ease-in-out;
    text-decoration: none;
  }

  .menu-link:hover,
  .menu-link-btn:hover {
    color: var(--cyan-hover);
  }
  .menu-link-btn {
    background: none;
    border: none;
  }
  #company-email,
  #company-name {
    font-weight: 300;
  }
  .dashboard-footer {
    width: 100%;
    height: 5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    padding: 1rem 5%;
    bottom: 0rem;
    color: var(--blanco-total);
    background-color: var(--azul-profundo);
    z-index: 10;
  }
  .footer-logo {
    height: 100%;
  }
  .footer-text {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 1px;
  }

  .dashboard-content {
    position: relative;
  }
  td img {
    width: 1.75rem;
    height: auto;
  }
  .glass-effect {
    /* 1. El color base: Blanco al 40% de opacidad */
    background: rgb(22 33 62 / 90%);

    /* 3. El estándar para Chrome, Edge, Firefox */
    backdrop-filter: blur(12px);

    /* 2. El truco para SAFARI (iOS/macOS) */
    -webkit-backdrop-filter: blur(12px);
  }

  @media (width >= 640px) {
    .stats-box > div {
      position: static !important;
      width: 100% !important;
    }
  }

  @media (width >= 768px) {
    #arrowLeft {
      margin-left: 0 !important;
    }
  }

  /*
		DESKTOP STYLES
	*/

  @media (width >= 940px) {
    .dashboard-header {
      margin: 2rem 0 0 -4.65rem;
      position: fixed;
      column-gap: 2rem;
    }
    .home-icon {
      margin-left: 0;
    }

    .back-link-container {
      position: sticky;
      left: -8rem;
      font-size: 0.75rem;
      gap: 0.125rem;
    }

    .back-icon {
      width: 1.125rem;
      max-width: 1.25rem;
    }
    .dashboard-footer {
      padding: 1rem calc(5% + 14px) 1rem 5%;
    }
    .glass-effect.m-only {
      background-color: transparent;

      /* 2. El truco para SAFARI (iOS/macOS) */
      -webkit-backdrop-filter: blur(0px);

      /* 3. El estándar para Chrome, Edge, Firefox */
      backdrop-filter: blur(0px);
    }
    .user-menu-row {
      flex-direction: row;
    }
  }
</style>
